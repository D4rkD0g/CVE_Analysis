## 0x00 CVE-2018–18921-CSRF

PHP Server Monitor 3.3.1

[官网](https://github.com/phpservermon/phpservermon)  
[issues](https://github.com/phpservermon/phpservermon/issues/670)

PHP Server Monitor version 3.3.1 and possibly before are affected by multiple Cross-Site Request Forgery vulnerability, an attacker could remove users, logs,and servers.

## 0x01 Analysis

[CVE-2018–18921 PHP Server Monitor 3.3.1 -Cross-Site Request Forgery](https://medium.com/bugbountywriteup/cve-2018-18921-php-server-monitor-3-3-1-cross-site-request-forgery-a73e8dae563)

The button to delete servers lacks an anti-CSRF token and also going via GET request.

[patch](https://github.com/phpservermon/phpservermon/commit/3524aaa782a9316587579beb6a7452ca63219158)

```php
//@@ -175,6 +175,25 @@ protected function validateRequest(\psm\Module\ControllerInterface $controller)

		if ($request->getMethod() == 'GET' && $request->query->get('action', '') == "delete") {
 			// require CSRF token for all GET calls that delete something
 			$session = $this->container->get('user')->getSession();
 			$token_in = $request->query->get('csrf', '');
 			$csrf_key = $controller->getCSRFKey();

 			if (empty($csrf_key)) {
 				if (!hash_equals($session->get('csrf_token'), $token_in)) {
 					throw new \InvalidArgumentException('invalid_csrf_token');
 				}
 			} else {
 				if (!hash_equals(
 					hash_hmac('sha256', $csrf_key, $session->get('csrf_token2')),
 					$token_in
 				)) {
 					throw new \InvalidArgumentException('invalid_csrf_token');
 				}
 			}
 		}

```


```php
// src/templates/default/main/macros.tpl.html
{% macro csrf_query() %}
&csrf={{ csrf_token(csrf_key|default('')) }}
{% endmacro %}
 ```


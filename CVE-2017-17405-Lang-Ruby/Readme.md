## 0x00 CVE-2017-17405-RCE

It turns out Ruby has its own FTP library and this is packaged as net/ftp. We started looking into the lib/net folder, half expecting a custom C implementation of FTP. Turns out there is a solitary ftp.rb file, and it only weighed in at 1496 lines of code. some functions are common vectors to gain Remote Code Execution (RCE) in Ruby applications.

`Net::FTP#get`, `getbinaryfile`, `gettextfile`, `put`, `putbinaryfile`, and `puttextfile` use `Kernel#open` to open a local file. If the localfile argument starts with the pipe character "|", the command following the pipe character is executed. The default value of `localfile` is `File.basename(remotefile)`, so malicious FTP servers could cause arbitrary command execution.

关联[CVE-2017-8817](https://curl.haxx.se/docs/CVE-2017-8817.html)

## 0x01 Analysis

[identifying-ruby-ftp-cve](https://blog.heroku.com/identifying-ruby-ftp-cve)  
[CVE-2017-17405: Command injection vulnerability in Net::FTP](https://www.ruby-lang.org/en/news/2017/12/14/net-ftp-command-injection-cve-2017-17405/)  

vuln example:

```ruby
785     def gettextfile(remotefile, localfile = File.basename(remotefile),
786                     &block) # :yield: line
787       f = nil
788       result = nil
789       if localfile
790         f = open(localfile, "w")
791       elsif !block_given?
792         result = String.new
793       end
794       begin
795         retrlines("RETR #{remotefile}") do |line, newline|
796           l = newline ? line + "\n" : line
797           f&.print(l)
798           block&.(line, newline)
799           result&.concat(l)
800         end
801         return result
802       ensure
803         f&.close
804       end
805     end
```

The localfile value would trigger command execution if the value was | os command  

[patch](https://github.com/ruby/ruby/compare/v2_4_2...v2_4_3#diff-591012d50ff69129fec34f4f853eba9b)  

The Ruby team simply replaced the open function with the File.open function, which is not vulnerable to command injection.